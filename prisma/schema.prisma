generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  supervisor
  operario
}

enum ProjectStatus {
  planning
  active
  paused
  completed
}

enum ProjectPriority {
  low
  medium
  high
  critical
}

enum TaskStatus {
  pending
  assigned
  in_progress
  completed
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  critical
}

enum TaskType {
  standard
  custom
}

enum EntityType {
  project
  task
  operario
  time_entry
}

enum ReportType {
  productivity
  time_tracking
  project_status
  operario_performance
}

enum MaterialCategory {
  estructura
  paneles
  herrajes
  aislacion
  electricidad
  sanitarios
  otros
}

enum UnitType {
  unidad
  metro
  metro_cuadrado
  metro_cubico
  kilogramo
  litro
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  password    String?
  role        UserRole
  total_hours Float    @default(0)
  efficiency  Float    @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  supervised_projects           Project[] @relation("ProjectSupervisor")
  assigned_tasks                Task[]    @relation("TaskAssignee")
  time_entries                  TimeEntry[]
  audit_logs                    AuditLog[]
  assigned_projects             ProjectOperario[]
  reports_generated             Report[]
  assigned_project_tasks        ProjectTask[] @relation("ProjectTaskAssignee")
  assigned_by_project_tasks     ProjectTask[] @relation("ProjectTaskAssignedBy")
  assigned_by_project_operarios ProjectOperario[] @relation("ProjectOperarioAssignedBy")
  assigned_by_project_materials ProjectMaterial[] @relation("ProjectMaterialAssignedBy")

  @@map("users")
}

model Project {
  id            String          @id @default(cuid())
  name          String
  description   String?
  status        ProjectStatus
  priority      ProjectPriority
  start_date    DateTime
  end_date      DateTime?
  progress      Float           @default(0)
  project_order Int?
  supervisor_id String?
  client_id     String?
  
  // Especificaciones t√©cnicas
  modulation    String          @default("standard")
  height        Float           @default(2.0)
  width         Float           @default(1.5)
  depth         Float           @default(0.8)
  module_count  Int             @default(1)
  
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  supervisor     User?            @relation("ProjectSupervisor", fields: [supervisor_id], references: [id], onDelete: SetNull)
  client         Client?          @relation(fields: [client_id], references: [id])
  time_entries   TimeEntry[]
  project_operarios ProjectOperario[]
  project_materials ProjectMaterial[]
  project_tasks  ProjectTask[]

  @@map("projects")
}

model Task {
  id               String       @id @default(cuid())
  title            String
  description      String?
  category         String?
  type             TaskType
  estimated_hours Float
  task_order       Int?
  created_by       String?
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  assigned_user User?       @relation("TaskAssignee", fields: [created_by], references: [id], onDelete: SetNull)
  time_entries TimeEntry[]
  project_tasks ProjectTask[]

  @@map("tasks")
}

model TimeEntry {
  id          String   @id @default(cuid())
  user_id     String
  task_id     String
  project_id  String
  start_time  DateTime
  end_time    DateTime?
  hours       Float    @default(0)
  description String?
  date        DateTime
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user    User    @relation(fields: [user_id], references: [id])
  task    Task    @relation(fields: [task_id], references: [id], onDelete: Cascade)
  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

model AuditLog {
  id           String     @id @default(cuid())
  user_id      String
  user_name    String
  action       String
  entity_type  EntityType
  entity_id    String
  entity_name  String
  changes      Json?
  ip_address   String?
  created_at   DateTime   @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

model Report {
  id           String     @id @default(cuid())
  name         String
  type         ReportType
  description  String?
  generated_by String
  parameters   Json?
  data         Json?
  created_at   DateTime   @default(now())

  generated_by_user User @relation(fields: [generated_by], references: [id])

  @@map("reports")
}

model ProjectOperario {
  id          String   @id @default(cuid())
  project_id  String
  user_id     String
  assigned_at DateTime @default(now())
  assigned_by String?

  project          Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user             User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  assigned_by_user User?   @relation("ProjectOperarioAssignedBy", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@unique([project_id, user_id])
  @@map("project_operarios")
}

model Client {
  id           String   @id @default(cuid())
  cuit         String   @unique
  company_name String
  representative String
  email        String
  phone        String
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  projects     Project[]

  @@map("clients")
}

model Material {
  id              String          @id @default(cuid())
  code            String          @unique
  name            String
  description     String?
  category        MaterialCategory
  unit            UnitType
  stock_quantity  Float           @default(0)
  min_stock       Float           @default(0)
  unit_price      Float?
  supplier        String?
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt

  project_materials ProjectMaterial[]

  @@map("materials")
}

model ProjectMaterial {
  id              String   @id @default(cuid())
  project_id      String
  material_id     String
  quantity        Float
  unit_price      Float?
  notes           String?
  assigned_at     DateTime @default(now())
  assigned_by     String?

  project          Project    @relation(fields: [project_id], references: [id], onDelete: Cascade)
  material         Material   @relation(fields: [material_id], references: [id])
  assigned_by_user User?      @relation("ProjectMaterialAssignedBy", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@unique([project_id, material_id])
  @@map("project_materials")
}

model ProjectTask {
  id                String    @id @default(cuid())
  project_id        String
  task_id           String
  status            TaskStatus @default(pending)
  estimated_hours   Float?
  actual_hours      Float     @default(0)
  assigned_to       String?
  assigned_by       String?
  start_date        DateTime?
  end_date          DateTime?
  progress_percentage Float    @default(0)
  notes             String?
  task_order        Int?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  project          Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  task             Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  assigned_user    User?    @relation("ProjectTaskAssignee", fields: [assigned_to], references: [id], onDelete: SetNull)
  assigned_by_user User?    @relation("ProjectTaskAssignedBy", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@map("project_tasks")
}