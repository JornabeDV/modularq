generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  supervisor
  operario
  subcontratista
}

enum ProjectStatus {
  planning
  active
  paused
  completed
  delivered
}

enum ProjectPriority {
  low
  medium
  high
  critical
}

enum ProjectCondition {
  alquiler
  venta
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  critical
}

enum TaskType {
  standard
  custom
}

enum EntityType {
  project
  task
  operario
  time_entry
}

enum ReportType {
  productivity
  time_tracking
  project_status
  operario_performance
}

enum MaterialCategory {
  estructura
  paneles
  herrajes
  aislacion
  electricidad
  sanitarios
  otros
}

enum UnitType {
  unidad
  metro
  metro_cuadrado
  metro_cubico
  kilogramo
  litro
}

enum PlanningChecklistItem {
  requirements        // Requerimientos del cliente
  general_plan        // Plano general y de estructura
  electrical_plan     // Plano de instalación eléctrica y listado materiales
  sanitary_plan       // Plano de instalación sanitaria y listado de materiales
  materials           // Materiales necesarios para dar inicio
  carpentry_plans     // Planos de carpintería
}

enum BudgetStatus {
  draft
  sent
  approved
  rejected
}

// Models
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  password    String?
  role        UserRole
  total_hours Float    @default(0)
  efficiency  Float    @default(0)
  deleted_at  DateTime?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  supervised_projects Project[] @relation("ProjectSupervisor")
  assigned_tasks      Task[]    @relation("TaskAssignee")
  time_entries        TimeEntry[]
  audit_logs          AuditLog[]
  assigned_projects    ProjectOperario[]
  reports_generated    Report[]
  assigned_project_tasks ProjectTask[] @relation("ProjectTaskAssignee")
  assigned_by_project_materials ProjectMaterial[] @relation("ProjectMaterialAssignedBy")

  started_project_tasks ProjectTask[] @relation("ProjectTaskStartedBy")
  completed_project_tasks ProjectTask[] @relation("ProjectTaskCompletedBy")
  completed_planning_items ProjectPlanningChecklist[]

  @@map("users")
}

model Project {
  id            String          @id @default(cuid())
  name          String
  description   String?
  status        ProjectStatus
  priority      ProjectPriority
  condition     ProjectCondition @default(venta)
  start_date    DateTime
  end_date      DateTime?
  progress      Float           @default(0)
  project_order Int?
  supervisor_id String?
  client_id     String?
  modulation    String          @default("standard")
  height        Float           @default(2.0)
  width         Float           @default(1.5)
  depth         Float           @default(0.8)
  module_count  Int             @default(1)
  
  // Relación con presupuesto (cuando se crea desde un presupuesto aprobado)
  budget        Budget?
  
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  supervisor     User?            @relation("ProjectSupervisor", fields: [supervisor_id], references: [id])
  client         Client?          @relation(fields: [client_id], references: [id])
  time_entries   TimeEntry[]
  project_operarios ProjectOperario[]
  project_materials ProjectMaterial[]
  project_tasks  ProjectTask[]
  planning_checklist ProjectPlanningChecklist[]

  @@map("projects")
}

model Task {
  id               String       @id @default(cuid())
  title            String
  description      String?
  category         String?
  type             TaskType
  estimated_hours Float
  task_order       Int?
  created_by       String?
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  assigned_user User?       @relation("TaskAssignee", fields: [created_by], references: [id])
  time_entries TimeEntry[]
  project_tasks ProjectTask[]

  @@map("tasks")
}

model TimeEntry {
  id          String   @id @default(cuid())
  user_id     String
  task_id     String
  project_id  String
  start_time  DateTime
  end_time    DateTime?
  hours       Float    @default(0)
  description String?
  date        DateTime
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user    User    @relation(fields: [user_id], references: [id])
  task    Task    @relation(fields: [task_id], references: [id], onDelete: Cascade)
  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

model AuditLog {
  id           String     @id @default(cuid())
  user_id      String
  user_name    String
  action       String
  entity_type  EntityType
  entity_id    String
  entity_name  String
  changes      Json?
  ip_address   String?
  created_at   DateTime   @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

model Report {
  id           String     @id @default(cuid())
  name         String
  type         ReportType
  description  String?
  generated_by String
  parameters   Json?
  data         Json?
  created_at   DateTime   @default(now())

  generated_by_user User @relation(fields: [generated_by], references: [id])

  @@map("reports")
}

model ProjectOperario {
  id          String   @id @default(cuid())
  project_id  String
  user_id     String
  assigned_at DateTime @default(now())

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id], references: [id])

  @@unique([project_id, user_id])
  @@map("project_operarios")
}

model Client {
  id           String   @id @default(cuid())
  cuit         String   @unique
  company_name String
  representative String?
  email        String?
  phone        String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  projects     Project[]
  contacts     ClientContact[]

  @@map("clients")
}

model Material {
  id              String          @id @default(cuid())
  code            String          @unique
  name            String
  description     String?
  category        MaterialCategory
  unit            UnitType
  stock_quantity  Float           @default(0)
  min_stock       Float           @default(0)
  unit_price      Float?
  supplier        String?
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt

  project_materials ProjectMaterial[]

  @@map("materials")
}

model ProjectMaterial {
  id              String   @id @default(cuid())
  project_id      String
  material_id     String
  quantity        Float
  unit_price      Float?
  notes           String?
  assigned_at     DateTime @default(now())
  assigned_by     String?

  project          Project    @relation(fields: [project_id], references: [id], onDelete: Cascade)
  material         Material   @relation(fields: [material_id], references: [id])
  assigned_by_user User?      @relation("ProjectMaterialAssignedBy", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@unique([project_id, material_id])
  @@map("project_materials")
}

model ProjectTask {
  id                String     @id @default(cuid())
  project_id        String
  task_id           String
  status            TaskStatus @default(pending)
  estimated_hours   Float      @default(0)
  actual_hours      Float      @default(0)
  assigned_to       String?
  start_date        DateTime?
  end_date          DateTime?
  progress_percentage Float    @default(0)
  notes             String?
  assigned_at       DateTime?
  task_order        Int        @default(0)
  // Campos de tracking de estado
  started_by        String?
  started_at        DateTime?
  completed_by      String?
  completed_at      DateTime?
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt

  // Relations
  project           Project    @relation(fields: [project_id], references: [id], onDelete: Cascade)
  task              Task       @relation(fields: [task_id], references: [id], onDelete: Cascade)
  assigned_user     User?      @relation("ProjectTaskAssignee", fields: [assigned_to], references: [id])
  started_by_user   User?      @relation("ProjectTaskStartedBy", fields: [started_by], references: [id])
  completed_by_user User?      @relation("ProjectTaskCompletedBy", fields: [completed_by], references: [id])

  @@map("project_tasks")
}

model ClientContact {
  id         String   @id @default(cuid())
  client_id  String
  name       String
  email      String
  phone      String
  role       String
  is_primary Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  client     Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@map("client_contacts")
}

model ProjectPlanningChecklist {
  id             String                @id @default(cuid())
  project_id     String
  checklist_item PlanningChecklistItem
  is_completed   Boolean               @default(false)
  notes          String?
  completed_at   DateTime?
  completed_by   String?
  created_at     DateTime              @default(now())
  updated_at     DateTime              @updatedAt

  project       Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  completed_by_user User? @relation(fields: [completed_by], references: [id])

  @@unique([project_id, checklist_item])
  @@map("project_planning_checklist")
}

// ==================== MÓDULO DE PRESUPUESTOS ====================

// Plantillas de ítems estándar para presupuestos
model BudgetItemTemplate {
  id          String   @id @default(cuid())
  code        String   // Ej: "1.1", "2.1"
  category    String   // Ej: "ESTRUCTURA METÁLICA", "PISO"
  description String
  unit        String   // kg, m2, un, etc.
  is_standard Boolean  @default(true)  // Aparece por defecto
  order       Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Análisis template (copiado al crear ítems)
  template_labors     Json?  // [{labor_concept_id, quantity_hours}]
  template_materials  Json?  // [{material_id, quantity}]
  template_equipments Json?  // [{name, quantity_hours, hourly_cost}]

  @@map("budget_item_templates")
}

// Conceptos de mano de obra (precios referenciales)
model LaborConcept {
  id           String   @id @default(cuid())
  code         String   @unique  // oficial-esp, oficial, ayudante
  name         String   // "Oficial especializado"
  category     String   // oficial_especializado, oficial, medio_oficial, ayudante
  hourly_rate  Float    // $/hora
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@map("labor_concepts")
}

// Presupuestos
model Budget {
  id          String       @id @default(cuid())
  budget_code String       @unique  // PRES-2026-001
  
  // Datos del cliente/proyecto
  client_id   String?
  client_name String
  location    String
  description String?      // Descripción del módulo

  status      BudgetStatus @default(draft)
  
  // Fechas
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  sent_at     DateTime?
  approved_at DateTime?
  rejected_at DateTime?
  
  // Referencia al proyecto creado (cuando se aprueba)
  project_id  String?      @unique
  project     Project?     @relation(fields: [project_id], references: [id])

  // Porcentajes
  financial_expenses_pct Float @default(0)
  general_expenses_pct   Float @default(17)
  benefit_pct            Float @default(40)
  iva_pct                Float @default(10.5)
  gross_income_pct       Float @default(0)

  // Totales calculados
  subtotal_direct_costs  Float // Suma de items
  subtotal_with_expenses Float // + gastos generales
  subtotal_with_benefit  Float // + beneficio
  calculated_price       Float // + impuestos
  final_price            Float // Precio final (editable)
  
  // Cotización del dólar al momento de aprobar (para referencia histórica)
  exchange_rate          Float?   // Cotización USD/ARS (BNA venta)
  exchange_rate_date     DateTime? // Fecha de la cotización

  // Condiciones comerciales editables
  validity_days     Int?     // Días de validez de la oferta
  payment_terms     String?  // Condiciones de pago
  delivery_terms    String?  // Términos de entrega
  delivery_location String?  // Lugar de entrega
  notes             String?  // Notas adicionales
  
  // Descripción comercial del módulo (array de secciones)
  module_description Json?   // [{ "section": "Estructura", "description": "..." }, ...]

  // Ítems del presupuesto
  items BudgetItem[]

  // Archivos adjuntos
  attachments BudgetAttachment[]

  @@map("budgets")
}

// Ítems de un presupuesto
model BudgetItem {
  id          String   @id @default(cuid())
  budget_id   String
  template_id String?  // Si viene de template

  // Datos del ítem
  code        String   // "1.1", "CUSTOM-1"
  category    String   // Rubro
  description String
  unit        String
  is_custom   Boolean  @default(false)
  order       Int      @default(0)

  // Cómputos (ingresado manualmente)
  quantity    Float

  // Costos calculados
  unit_cost_labor     Float // Mano de obra unitaria
  unit_cost_materials Float // Materiales unitario
  unit_cost_equipment Float // Equipos unitario
  unit_cost_total     Float // Total unitario
  total_cost          Float // quantity × unit_cost_total

  budget Budget @relation(fields: [budget_id], references: [id], onDelete: Cascade)
  
  // Análisis de precios específico de este ítem
  price_analysis BudgetItemPriceAnalysis?

  @@map("budget_items")
}

// Análisis de precios por ítem
model BudgetItemPriceAnalysis {
  id            String     @id @default(cuid())
  budget_item_id String    @unique
  budget_item   BudgetItem @relation(fields: [budget_item_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Desgloses
  labors     BudgetItemLabor[]
  materials  BudgetItemMaterial[]
  equipments BudgetItemEquipment[]

  @@map("budget_item_price_analyses")
}

// Desglose de mano de obra en análisis
model BudgetItemLabor {
  id          String   @id @default(cuid())
  analysis_id String
  
  labor_concept_id String
  quantity_hours   Float // Horas necesarias
  
  // Calculado
  hourly_rate Float // Copia del concepto al momento
  total_cost  Float // quantity_hours × hourly_rate

  analysis BudgetItemPriceAnalysis @relation(fields: [analysis_id], references: [id], onDelete: Cascade)

  @@map("budget_item_labors")
}

// Desglose de materiales en análisis
model BudgetItemMaterial {
  id          String   @id @default(cuid())
  analysis_id String
  
  material_id String?
  material_name String? // Si no está en catálogo
  quantity    Float
  
  // Calculado
  unit_price Float? // De materials o manual
  total_cost Float // quantity × unit_price

  analysis BudgetItemPriceAnalysis @relation(fields: [analysis_id], references: [id], onDelete: Cascade)

  @@map("budget_item_materials")
}

// Desglose de equipos en análisis
model BudgetItemEquipment {
  id          String   @id @default(cuid())
  analysis_id String
  
  name            String
  quantity_hours  Float
  hourly_cost     Float
  total_cost      Float // quantity_hours × hourly_cost

  analysis BudgetItemPriceAnalysis @relation(fields: [analysis_id], references: [id], onDelete: Cascade)

  @@map("budget_item_equipments")
}

// Tipos de documentos para archivos adjuntos
enum DocumentType {
  project_image    // Imágenes de proyectos (muestran en grid)
  technical_plan   // Planos técnicos (muestran en hoja completa)
}

// Archivos adjuntos de presupuestos (imágenes y PDFs)
model BudgetAttachment {
  id          String   @id @default(cuid())
  budget_id   String
  
  // Información del archivo
  filename    String   // Nombre original del archivo
  original_name String // Nombre original con extensión
  mime_type   String   // image/jpeg, application/pdf, etc.
  file_type   String   // "image" | "pdf"
  document_type DocumentType @default(project_image) // Tipo de documento
  size        Int      // Tamaño en bytes
  
  // URLs de Cloudinary
  url         String   // URL completa del archivo
  public_id   String   // ID público de Cloudinary para eliminar
  thumbnail_url String? // URL de thumbnail (solo para imágenes)
  
  // Metadatos
  description String?  // Descripción opcional del archivo
  uploaded_by String?  // ID del usuario que subió el archivo
  
  // Timestamps
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relaciones
  budget      Budget   @relation(fields: [budget_id], references: [id], onDelete: Cascade)

  @@map("budget_attachments")
}