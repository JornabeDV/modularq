#!/bin/bash

# Pre-commit hook para ModulArq
# Este script se ejecuta automÃ¡ticamente antes de cada commit

echo "ğŸ” Running pre-commit validations..."

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# FunciÃ³n para mostrar errores
show_error() {
    echo -e "${RED}âŒ $1${NC}"
    exit 1
}

# FunciÃ³n para mostrar Ã©xito
show_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# FunciÃ³n para mostrar advertencias
show_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Verificar que estamos en el directorio correcto
if [ ! -f "package.json" ]; then
    show_error "No se encontrÃ³ package.json. Ejecuta este script desde la raÃ­z del proyecto."
fi

# 1. Verificar que no hay archivos sin agregar al staging
echo "ğŸ“ Checking for unstaged files..."
if ! git diff --quiet; then
    show_warning "Hay archivos modificados que no estÃ¡n en staging. Considera agregarlos con 'git add'"
fi

# 2. Ejecutar type checking
echo "ğŸ“ Running TypeScript type checking..."
if ! pnpm type-check; then
    show_error "TypeScript type checking failed. Fix the errors before committing."
fi
show_success "TypeScript type checking passed"

# 3. Ejecutar linting
echo "ğŸ” Running ESLint..."
if ! pnpm lint; then
    show_error "ESLint found issues. Fix them before committing."
fi
show_success "ESLint passed"

# 4. Ejecutar tests rÃ¡pidos (solo los que no requieren setup completo)
echo "ğŸ§ª Running quick tests..."
if ! pnpm test --passWithNoTests --watchAll=false; then
    show_error "Tests failed. Fix the issues before committing."
fi
show_success "Tests passed"

# 5. Verificar que el build funciona
echo "ğŸ”¨ Testing build..."
if ! pnpm build; then
    show_error "Build failed. Fix the issues before committing."
fi
show_success "Build test passed"

# 6. Verificar tamaÃ±o del bundle (opcional)
echo "ğŸ“Š Checking bundle size..."
if [ -f ".next/analyze" ]; then
    BUNDLE_SIZE=$(du -sh .next | cut -f1)
    echo "Bundle size: $BUNDLE_SIZE"
fi

# 7. Verificar que no hay secrets en el cÃ³digo
echo "ğŸ” Checking for secrets..."
if grep -r "password\|secret\|key\|token" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | grep -v ".git" | grep -v "test" | grep -v "example"; then
    show_warning "Posibles secrets encontrados en el cÃ³digo. Revisa antes de hacer commit."
fi

echo ""
show_success "ğŸ‰ Pre-commit validations passed! Ready to commit."
echo ""
echo "ğŸ’¡ Tips:"
echo "   - Si falla algo, usa 'git commit --no-verify' para saltar las validaciones (NO recomendado)"
echo "   - Para hacer commit rÃ¡pido: 'git commit -m \"mensaje\"'"
echo "   - Para hacer commit con descripciÃ³n: 'git commit' (abrirÃ¡ el editor)"
echo ""